<!DOCTYPE html>
<html>
<head>
<title>Sign In</title>
<link rel="stylesheet" href="/css/styles.css" />
<script type="text/javascript" src=" https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript">
var imghtml = '<img src="/img/loading.gif" />';

$(function () {
    $('#signin').submit(function() {
        var name = $('#name').val();
        var email = $('#email').val();
        prependUser(name, email);
        
        return false;
    });
})

function prependUser(name, email)
{
    var logcontent = name + ' ('+email+') has signed in.';
    var spanhtml = '<span>'+logcontent+'</span>';
    
    var loghtml = '<div class="listentry first">'+spanhtml+'</div>';

    if (name != '' || email != '')
    {
        $('#log div.first').removeClass('first');
        
        $('#log').prepend(loghtml);
        $('#log div.first').hide().slideDown();
        
        signinUser($('#log div.first'), name, email);
    }
}

function signinUser(tag, name, email) 
{   
    $.ajax({
        url: '/signin',
        dataType: 'json',
        data: {'name': name, 'email': email},
        beforeSend: function(jqXHR, settings) {
            tag.addClass('loading');
            tag.append(imghtml);
        },
        success: function(data, textStatus, jqXHR) {
            if (data.status == 'success')
                signInSuccess(tag);
            else
                signInError(tag, name, email);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            signInError(tag, name, email);
        },
        complete: function(jqXHR, textStatus) {
            tag.removeClass('loading');
        }
    })
}

function signInSuccess(tag) {
    tag.find('img').attr('src', '/img/tick.png');
}

function signInError(tag, name, email) {
    tag.addClass('error');
    tag.find('img').attr('src', '/img/cross.png');
    errormsg = name + ' (' + email + ') ' + 'has failed. Please try again.'
    tag.find('span').text(errormsg);
}

</script>
</head>

<body>

<h1>Sign In</h1>
<h2>{{ organization }} {{ event }}</h2>

<form id="signin" action="/event" method="get">

<fieldset name="signin.fields" class="center">
<legend>Sign In</legend>
<div class="fields center">
    <div class="field">
        <label for="name">Name:</label>
        <input id="name" name="name" type="text" />
    </div>
    <div class="field">
        <label for="email">Email:</label>
        <input id="email" name="email" type="email" />
    </div>
    <div class="field">
        <label></label>
        <input type="submit" value="Sign In" />
    </div>
</div>
</fieldset>

<input name="organization" type="hidden" value="{{ organization }}" />
<input name="event" type="hidden" value="{{ event }}" />
<input name="date" type="hidden" value="{{ date }}" />

<img src="/img/loading.gif" class="nodisplay"/>
<img src="/img/tick.png" class="nodisplay"/>
<img src="/img/cross.png" class="nodisplay"/>

</form>

<section id="log">
</section>

</body>
<html>